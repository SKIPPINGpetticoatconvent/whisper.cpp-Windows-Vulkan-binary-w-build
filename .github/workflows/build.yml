name: Build Windows Vulkan

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release Tag (e.g. v1.0.0)"
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        shell: powershell
        run: |
          $vulkanVersion = "1.3.290.0"
          $vulkanSdkUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
          $vulkanSdkInstaller = "VulkanSDK-Installer.exe"

          Write-Host "Downloading Vulkan SDK from $vulkanSdkUrl"
          Invoke-WebRequest -Uri $vulkanSdkUrl -OutFile $vulkanSdkInstaller

          Write-Host "Installing Vulkan SDK..."
          Start-Process -FilePath $vulkanSdkInstaller -ArgumentList "/S" -Wait

          $vulkanPath = "C:\VulkanSDK\$vulkanVersion"
          Write-Host "Setting environment variables for $vulkanPath"

          echo "VULKAN_SDK=$vulkanPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$vulkanPath\Bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$vulkanPath\Lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$vulkanPath\Include" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake
        run: cmake -B build -DGGML_VULKAN=ON -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release -j 4

      - name: Copy DLLs
        shell: powershell
        run: |
          Copy-Item -Path "$env:VULKAN_SDK\Bin\glslc.exe" -Destination "build\bin\Release\"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: whisper-windows-vulkan-binaries
          path: |
            build/bin/Release/*.exe
            build/bin/Release/*.dll

      - name: Zip Release
        if: inputs.release_tag != ''
        shell: powershell
        run: |
          Compress-Archive -Path build\bin\Release\* -DestinationPath whisper-windows-vulkan-${{ inputs.release_tag }}.zip

      - name: Create Release
        if: inputs.release_tag != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: whisper-windows-vulkan-${{ inputs.release_tag }}.zip
