name: 构建 Windows Vulkan

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "发布标签 (例如 v1.0.0)"
        required: false
        type: string

env:
  VULKAN_VERSION: "1.3.290.0"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 安装 Vulkan SDK
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          choco install vulkan-sdk --version ${{ env.VULKAN_VERSION }}

      - name: 配置 Vulkan 环境变量
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $vulkanPath = "C:\VulkanSDK\${{ env.VULKAN_VERSION }}"
          Write-Host "正在为 $vulkanPath 设置环境变量"

          # 确保目录存在 (如果是从缓存恢复的，这一步是验证)
          if (-not (Test-Path $vulkanPath)) {
             Write-Error "Vulkan SDK 路径不存在: $vulkanPath"
             exit 1
          }

          echo "VULKAN_SDK=$vulkanPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$vulkanPath\Bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$vulkanPath\Lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$vulkanPath\Include" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 安装 Ninja 构建工具
        run: choco install ninja

      - name: 配置 CMake
        run: cmake -B build -G Ninja -DGGML_VULKAN=ON -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON

      - name: 构建
        run: cmake --build build --config Release --parallel 8

      - name: 复制 DLL 依赖
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          # Ninja 构建系统中，输出目录通常直接在 build/bin/ 下，没有 Release 子目录
          Copy-Item -Path "$env:VULKAN_SDK\Bin\glslc.exe" -Destination "build\bin\"

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: whisper-windows-vulkan-binaries
          path: |
            build/bin/*.exe
            build/bin/*.dll

      - name: 压缩发布包
        if: inputs.release_tag != ''
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Compress-Archive -Path build\bin\* -DestinationPath whisper-windows-vulkan-${{ inputs.release_tag }}.zip

      - name: 创建 Release 发布
        if: inputs.release_tag != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: whisper-windows-vulkan-${{ inputs.release_tag }}.zip
