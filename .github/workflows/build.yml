name: 构建 Windows Vulkan

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "发布标签 (例如 v1.0.0)"
        required: false
        type: string

env:
  VULKAN_VERSION: "1.3.290.0"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          repository: ggml-org/whisper.cpp
          path: whisper.cpp
          submodules: recursive

      - name: 移动源代码到短路径
        shell: pwsh
        run: |
          Move-Item -Path "whisper.cpp" -Destination "D:\w"

      - name: 缓存 Vulkan SDK
        id: cache-vulkan
        uses: actions/cache@v4
        with:
          path: C:\VulkanSDK\${{ env.VULKAN_VERSION }}
          key: vulkan-sdk-${{ env.VULKAN_VERSION }}

      - name: 安装 Vulkan SDK
        if: steps.cache-vulkan.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          curl -L -o VulkanSDK-Installer.exe https://sdk.lunarg.com/sdk/download/%VULKAN_VERSION%/windows/VulkanSDK-%VULKAN_VERSION%-Installer.exe
          echo Extracting Vulkan SDK...
          7z x VulkanSDK-Installer.exe -oC:\VulkanSDK\%VULKAN_VERSION% -y

      - name: 配置 Vulkan 环境变量
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $vulkanPath = "C:\VulkanSDK\${{ env.VULKAN_VERSION }}"
          Write-Host "正在为 $vulkanPath 设置环境变量"

          # 确保目录存在 (如果是从缓存恢复的，这一步是验证)
          if (-not (Test-Path $vulkanPath)) {
             Write-Error "Vulkan SDK 路径不存在: $vulkanPath"
             exit 1
          }

          echo "VULKAN_SDK=$vulkanPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$vulkanPath\Bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$vulkanPath\Lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$vulkanPath\Include" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 配置 CMake
        run: cmake -S D:\w -B D:\w\build -G "Visual Studio 17 2022" -A x64 -DGGML_VULKAN=1 -DBUILD_SHARED_LIBS=ON

      - name: 构建
        run: cmake --build D:\w\build --config Release --parallel 8

      - name: 复制 DLL 依赖
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          # MSVC 构建会将二进制文件放在 bin/Release 目录下
          $binPath = "D:\w\build\bin\Release"

          Copy-Item -Path "$env:VULKAN_SDK\Bin\glslc.exe" -Destination $binPath

          # 将构建产物复制回工作区以便上传
          New-Item -ItemType Directory -Force -Path "build\bin"
          Copy-Item -Path "$binPath\*" -Destination "build\bin"

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: whisper-windows-vulkan-binaries
          path: |
            build/bin/*.exe
            build/bin/*.dll

      - name: 压缩发布包
        if: inputs.release_tag != ''
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Compress-Archive -Path build\bin\* -DestinationPath whisper-windows-vulkan-${{ inputs.release_tag }}.zip

      - name: 创建 Release 发布
        if: inputs.release_tag != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: whisper-windows-vulkan-${{ inputs.release_tag }}.zip
